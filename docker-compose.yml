services:
  # 1. SQL Server
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sql_container
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Password123!
    ports:
      - "1434:1433"
    networks:
      - chagee-net
    # üëá B·∫ÆT BU·ªòC PH·∫¢I C√ì PH·∫¶N N√ÄY
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "Password123!", "-C", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # 2. Backend
  backend:
    build: ./backend
    container_name: backend_container
    ports:
      - "8080:8080"
    # üëá S·ª¨A C√ö PH√ÅP T·∫†I ƒê√ÇY (B·ªè d·∫•u g·∫°ch ngang tr∆∞·ªõc sqlserver)
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - chagee-net
    environment:
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://sqlserver:1433;databaseName=chagee_db;encrypt=true;trustServerCertificate=true;
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=Password123!
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

  # 3. Frontend (Ch·∫ø ƒë·ªô DEV)
  frontend:
    build: ./frontend
    container_name: frontend_container
    ports:
      - "3001:3001"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    stdin_open: true
    tty: true
    depends_on:
      - backend
    networks:
      - chagee-net

networks:
  chagee-net:
    driver: bridge